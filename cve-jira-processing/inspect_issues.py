#!/usr/bin/env python3
"""Inspect Jira issues - show status and links."""

import argparse
import logging
import sys
from pathlib import Path

from lib.jira_client import JiraTool

logger = logging.getLogger(__name__)


def read_issues_from_file(file_path: Path) -> list[str]:
    """Read issue keys from a file (one per line)."""
    issues = []
    with open(file_path, "r") as f:
        for line in f:
            line = line.strip()
            # Skip empty lines and comments
            if line and not line.startswith("#"):
                # Handle comma-separated values on same line
                for key in line.split(","):
                    key = key.strip()
                    if key:
                        issues.append(key)
    return issues


def extract_name(field_value) -> str:
    """Extract name from a Jira field value (handles dict or direct value)."""
    if field_value is None:
        return None
    if isinstance(field_value, dict):
        return field_value.get("name", str(field_value))
    return str(field_value)


def inspect_issue(client: JiraTool, issue_key: str) -> dict:
    """Get status and links for an issue."""
    try:
        issue_data = client.get_jira_issue(
            issue_key, field_filter=["Status", "Summary", "Issue Type", "Resolution"]
        )
        links = client.get_issue_links(issue_key)

        return {
            "key": issue_key,
            "summary": issue_data.get("Summary", "N/A"),
            "type": extract_name(issue_data.get("Issue Type")) or "N/A",
            "status": extract_name(issue_data.get("Status")) or "N/A",
            "resolution": extract_name(issue_data.get("Resolution")),
            "links": links,
            "error": None,
        }
    except Exception as e:
        return {"key": issue_key, "error": str(e)}


def format_links(links: list[dict]) -> list[str]:
    """Format links for display."""
    formatted = []
    for link in links:
        link_type = link.get("type", "unknown")
        direction = link.get("direction", "unknown")
        linked_issue = link.get("issue_key", "unknown")

        if direction == "inward":
            formatted.append(f"← {link_type}: {linked_issue}")
        else:
            formatted.append(f"→ {link_type}: {linked_issue}")

    return formatted


def print_issue(issue_info: dict) -> None:
    """Print issue information."""
    key = issue_info["key"]

    if issue_info.get("error"):
        print(f"\n{key}: ERROR - {issue_info['error']}")
        return

    status = issue_info["status"]
    resolution = issue_info["resolution"]
    issue_type = issue_info["type"]
    summary = issue_info["summary"]
    links = issue_info.get("links", [])

    status_str = status
    if resolution and resolution != "None":
        status_str = f"{status} ({resolution})"

    print(f"\n{key} [{issue_type}] - {status_str}")
    print(f"  Summary: {summary}")

    if links:
        print("  Links:")
        for link_str in format_links(links):
            print(f"  {link_str}")
    else:
        print("  Links: (none)")


def setup_logging(verbose: bool = False):
    """Configure logging."""
    level = logging.DEBUG if verbose else logging.WARNING
    logging.basicConfig(
        level=level,
        format="%(asctime)s - %(levelname)s - %(message)s",
        datefmt="%Y-%m-%d %H:%M:%S",
    )


def main():
    parser = argparse.ArgumentParser(
        description="Inspect Jira issues - show status and links"
    )
    parser.add_argument(
        "issues",
        nargs="*",
        help="Issue keys to inspect (e.g., OCPBUGS-12345 OSASINFRA-67890)",
    )
    parser.add_argument(
        "-f",
        "--file",
        type=Path,
        help="File containing issue keys (one per line)",
    )
    parser.add_argument(
        "-v", "--verbose", action="store_true", help="Enable verbose logging"
    )
    args = parser.parse_args()

    setup_logging(args.verbose)

    # Collect issues from arguments and/or file
    issues = list(args.issues) if args.issues else []

    if args.file:
        if not args.file.exists():
            print(f"Error: File not found: {args.file}", file=sys.stderr)
            sys.exit(1)
        issues.extend(read_issues_from_file(args.file))

    if not issues:
        parser.print_help()
        print("\nError: No issue keys provided", file=sys.stderr)
        sys.exit(1)

    print(f"Inspecting {len(issues)} issue(s)...")

    client = JiraTool()

    for issue_key in issues:
        issue_info = inspect_issue(client, issue_key)
        print_issue(issue_info)

    print()


if __name__ == "__main__":
    main()
